<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µë™ê¸°ë¡ë³´ê´€ì†Œ</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #888;
            --point-color: #f1c40f; 
            --accent-green: #2ecc71;
            --accent-blue: #3498db;
        }

        body { 
            font-family: 'Pretendard', -apple-system, sans-serif; 
            max-width: 500px; margin: 0 auto; padding: 0; 
            background: var(--bg-color); color: var(--text-main);
            overflow-x: hidden;
        }
        
        .container { padding: 20px; }
        h1 { text-align: center; color: #fff; letter-spacing: 2px; }

        .tab-menu { display: flex; background: var(--card-bg); border-radius: 15px; padding: 5px; margin: 20px 0; }
        .tab-btn { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 10px; color: var(--text-sub); font-weight: bold; }
        .tab-btn.active { background: #333; color: var(--point-color); }

        .section { display: none; }
        .section.active { display: block; }

        /* ê²€ìƒ‰ë°” ì˜ì—­ */
        .search-wrapper { position: sticky; top: 0; background: var(--bg-color); z-index: 100; padding-bottom: 10px; }
        .search-bar, input, textarea, select { 
            width: 100%; padding: 12px; border: 1px solid #333; border-radius: 12px; 
            background: #000; color: white; outline: none; box-sizing: border-box; margin-bottom: 10px;
        }

        /* ê·¸ë¦¬ë“œ ë° ì¹´ë“œ */
        .shelf-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px 10px; }
        .book-card { cursor: pointer; position: relative; }
        
        .book-cover-wrapper {
            width: 100%; aspect-ratio: 2 / 3;
            background: #222; border-radius: 8px; overflow: hidden;
            border: 1px solid #333; position: relative;
        }
        .book-cover { width: 100%; height: 100%; object-fit: cover; }

        .status-badge {
            position: absolute; top: 5px; left: 5px; font-size: 0.6rem;
            padding: 2px 5px; border-radius: 4px; font-weight: bold; color: white; z-index: 2;
        }
        .badge-done { background: var(--accent-green); }
        .badge-reading { background: var(--accent-blue); }
        .badge-wish { background: #555; }

        .card-info { margin-top: 8px; }
        .card-title {
            font-size: 0.8rem; font-weight: bold; color: #fff;
            display: -webkit-box; -webkit-box-orient: vertical; 
            -webkit-line-clamp: 1; line-clamp: 1;
            overflow: hidden;
        }
        .card-author { 
            font-size: 0.7rem; color: var(--text-sub); margin-top: 2px;
            display: -webkit-box; -webkit-box-orient: vertical; 
            -webkit-line-clamp: 1; line-clamp: 1;
            overflow: hidden;
        }
        .card-stars { font-size: 0.65rem; color: var(--point-color); margin-top: 3px; }

        /* ê²€ìƒ‰ ë¬¸ì¥ í•˜ì´ë¼ì´íŠ¸ */
        .search-match {
            font-size: 0.75rem; color: var(--point-color);
            background: rgba(241, 196, 15, 0.1); padding: 8px;
            border-radius: 8px; margin-top: 8px; border-left: 3px solid var(--point-color);
            line-height: 1.4; 
            display: -webkit-box; -webkit-box-orient: vertical; 
            -webkit-line-clamp: 2; line-clamp: 2;
            overflow: hidden;
        }

        /* ì„œì¬ í—¤ë” ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .shelf-profile-header {
            display: flex; align-items: center; gap: 12px; margin-bottom: 15px;
        }
        .shelf-profile-img {
            width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #333;
        }

        #book-detail-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            display: none; overflow-y: auto;
            animation: slideIn 0.3s forwards;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .detail-header { position: sticky; top: 0; background: rgba(18,18,18,0.95); padding: 15px; display: flex; align-items: center; gap: 15px; z-index: 10; border-bottom: 1px solid #222; }
        .back-btn { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }

        .detail-hero { display: flex; padding: 25px; gap: 20px; background: linear-gradient(180deg, #1e1e1e 0%, #121212 100%); }
        .hero-cover { width: 110px; aspect-ratio: 2/3; border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); object-fit: cover; }
        .hero-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }

        .detail-content { padding: 20px; padding-bottom: 80px; }
        .detail-label { font-size: 0.75rem; color: var(--point-color); font-weight: bold; margin-top: 20px; display: block; border-bottom: 1px solid #222; padding-bottom: 5px; }
        
        .info-row { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem; }
        .quote-item { background: #1e1e1e; padding: 15px; border-radius: 12px; margin-top: 10px; border-left: 4px solid var(--point-color); font-style: italic; color: #ccc; font-size: 0.9rem; }
        .comment-box { background: #1e1e1e; padding: 15px; border-radius: 12px; margin-top: 10px; line-height: 1.6; color: #ddd; white-space: pre-wrap; }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-black { background: var(--point-color); color: #000; }
        .btn-sub { background: #222; color: #ccc; }

        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); display: none; z-index: 3000; padding: 20px; overflow-y: auto; }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 20px; max-width: 400px; margin: 20px auto; }
        
        .field-group { margin-bottom: 15px; }
        .field-group label { font-size:0.75rem; color:#888; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ“š READING LOG</h1>

        <div class="tab-menu">
            <div id="tab-search" class="tab-btn active" onclick="showSection('search')">ì±… ê²€ìƒ‰</div>
            <div id="tab-library" class="tab-btn" onclick="showSection('library')">ë‚´ ì„œì¬</div>
        </div>

        <div id="search-section" class="section active">
            <input type="text" class="search-bar" id="realtime-search" placeholder="ì œëª©ì´ë‚˜ ì‘ê°€ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”">
            <div id="book-list" style="margin-top:20px;"></div>
        </div>

        <div id="library-section" class="section">
            <div class="search-wrapper">
                <input type="text" class="search-bar" id="library-filter-search" placeholder="í†µí•© ê²€ìƒ‰ (ì œëª©, ì¸ìš©êµ¬ ë“±)..." oninput="filterLibraryBooks()">
            </div>
            
            <div id="shelf-container" style="margin-top:10px;"></div>

            <div id="shelf-content-area" style="display:none; margin-top:10px;">
                <div id="shelf-header-info"></div>
                <button id="back-to-shelves-btn" class="btn btn-sub" onclick="goBackToShelves()" style="margin-bottom: 20px; width: auto; padding: 8px 15px; font-size: 0.8rem;">â† ì„œì¬ ëª©ë¡</button>
                <div id="shelf-book-list" class="shelf-grid"></div>
            </div>
        </div>
    </div>

    <div id="book-detail-page">
        <div class="detail-header">
            <button class="back-btn" onclick="closeDetailPage()">âœ•</button>
            <span style="font-size: 0.8rem; color: #888;">ìƒì„¸ ë³´ê¸°</span>
        </div>
        <div id="detail-body"></div>
    </div>

    <div class="modal-overlay" id="record-modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">ì •ë³´ ìˆ˜ì •</h3>
            <div class="field-group"><label>ì±… ì œëª©</label><input type="text" id="edit-title"></div>
            <div class="field-group"><label>ì €ì</label><input type="text" id="edit-author"></div>
            <div class="field-group"><label>ì¶œíŒì‚¬</label><input type="text" id="edit-publisher"></div>
            <div class="field-group"><label>í‘œì§€ URL</label><input type="text" id="edit-thumbnail"></div>
            <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">
            <div class="field-group">
                <label>ìƒíƒœ</label>
                <select id="status-select" onchange="toggleDateInput()">
                    <option value="wish">ğŸ“Œ ì½ì„ ì˜ˆì •</option>
                    <option value="reading">ğŸ“– ì½ëŠ” ì¤‘</option>
                    <option value="done">âœ… ì™„ë…</option>
                </select>
            </div>
            <div id="date-input-group" style="display:none;" class="field-group"><label>ì™„ë…ì¼</label><input type="date" id="finish-date"></div>
            <div class="field-group">
                <label>í‰ì </label>
                <select id="rating-select">
                    <option value="5">â­â­â­â­â­</option><option value="4">â­â­â­â­</option><option value="3">â­â­â­</option><option value="2">â­â­</option><option value="1">â­</option>
                </select>
            </div>
            <div class="field-group">
                <label>ë¬¸ì¥ ê¸°ë¡</label>
                <div id="quote-area"></div>
                <button class="btn btn-sub" style="font-size:11px; padding:5px; margin-top:5px; width: auto;" onclick="addQuoteInput()">+ ë¬¸ì¥ ì¶”ê°€</button>
            </div>
            <div class="field-group"><label>ê°ìƒí‰</label><textarea id="comment-input" rows="4"></textarea></div>
            <div class="field-group"><label>ì„œì¬ ì´ë™</label><select id="shelf-select"></select></div>
            <button class="btn btn-black" onclick="saveRecord()">ì €ì¥í•˜ê¸°</button>
            <button class="btn btn-sub" onclick="closeModal('record-modal')">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAOHQOxP3XPyPxbpBup5aXc-vlbUb4jOBQ",
            authDomain: "bookshelf-2b0d4.firebaseapp.com",
            projectId: "bookshelf-2b0d4",
            storageBucket: "bookshelf-2b0d4.firebasestorage.app",
            messagingSenderId: "673778381324",
            appId: "1:673778381324:web:e1e894eeeda99dd5447429",
            measurementId: "G-11ZNNS7X15"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const KAKAO_KEY = '2c5c125e533ea6428647d2e3dcb9e61b';

        let currentShelfId = null;
        let editingBookId = null;
        let searchTimer;
        let allMyBooks = [];

        async function loadShelves() {
            const snap = await db.collection("shelves").get();
            const container = document.getElementById('shelf-container');
            const bSnap = await db.collection("my_books").get();
            allMyBooks = bSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            container.innerHTML = snap.docs.map(doc => `
                <div style="background:#1e1e1e; padding:15px; border-radius:15px; margin-bottom:10px; display:flex; align-items:center; gap:15px; cursor:pointer;" onclick="openShelfDetail('${doc.id}')">
                    <img src="${doc.data().img}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;" onerror="this.src='https://via.placeholder.com/150'">
                    <div><strong>${doc.data().name}</strong></div>
                </div>`).join('');
        }

        // [ìœˆë„ìš° íƒìƒ‰ê¸°í˜• í†µí•© ê²€ìƒ‰ ë¡œì§]
        function filterLibraryBooks() {
            const keyword = document.getElementById('library-filter-search').value.toLowerCase();
            const shelfContainer = document.getElementById('shelf-container');
            const shelfContentArea = document.getElementById('shelf-content-area');
            const shelfBookList = document.getElementById('shelf-book-list');
            const headerInfo = document.getElementById('shelf-header-info');

            if (keyword.length < 1) {
                if (currentShelfId) openShelfDetail(currentShelfId);
                else goBackToShelves();
                return;
            }

            let searchScope = allMyBooks;
            let currentShelfData = null;
            if (currentShelfId) {
                searchScope = allMyBooks.filter(b => b.shelf === currentShelfId);
                // í˜„ì¬ ì„œì¬ ì´ë¯¸ì§€ ìœ ì§€ë¥¼ ìœ„í•´ ë°ì´í„° ì°¾ê¸°
            }

            const filtered = searchScope.filter(b => {
                const inQuotes = (b.quotes || []).some(q => q.toLowerCase().includes(keyword));
                const inComment = (b.comment || "").toLowerCase().includes(keyword);
                const inTitle = (b.title || "").toLowerCase().includes(keyword);
                const inAuthor = (b.author || "").toLowerCase().includes(keyword);
                return inQuotes || inComment || inTitle || inAuthor;
            });

            shelfContainer.style.display = 'none';
            shelfContentArea.style.display = 'block';
            
            // ê²€ìƒ‰ í—¤ë” í‘œì‹œ
            headerInfo.innerHTML = `
                <div class="shelf-profile-header">
                    <div style="font-size: 1.2rem;">ğŸ”</div>
                    <h3 style="color:var(--point-color); margin:0;">${currentShelfId ? 'í˜„ì¬ ì„œì¬ ë‚´ ê²€ìƒ‰' : 'ì „ì²´ ì„œì¬ ê²€ìƒ‰'}</h3>
                </div>`;

            shelfBookList.className = ""; 
            if (filtered.length === 0) {
                shelfBookList.innerHTML = `<p style="text-align:center; color:#555; padding:40px 0;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            shelfBookList.innerHTML = filtered.map(b => {
                const stars = "â­".repeat(b.rating || 0);
                let matchSnippet = "";
                const foundQuote = (b.quotes || []).find(q => q.toLowerCase().includes(keyword));
                if (foundQuote) matchSnippet = `<div class="search-match">ğŸ’¬ ì¸ìš©êµ¬: "...${foundQuote}..."</div>`;
                else if ((b.comment || "").toLowerCase().includes(keyword)) matchSnippet = `<div class="search-match">ğŸ“ ê°ìƒí‰: "...${b.comment}..."</div>`;

                return `
                    <div style="display:flex; gap:12px; background:var(--card-bg); padding:15px; border-radius:15px; cursor:pointer; margin-bottom:12px;" onclick="openDetailPage('${b.id}')">
                        <img src="${b.thumbnail}" style="width:55px; height:80px; border-radius:6px; object-fit:cover;" onerror="this.src='https://via.placeholder.com/150'">
                        <div style="flex:1; min-width:0;">
                            <div class="card-title" style="font-size:0.95rem;">${b.title}</div>
                            <div class="card-author">${b.author || 'ì‘ê°€ ë¯¸ìƒ'} | ${stars}</div>
                            ${matchSnippet}
                        </div>
                    </div>`;
            }).join('');
        }

        // [ì„œì¬ ìƒì„¸ ì§„ì… - í”„ë¡œí•„ ì´ë¯¸ì§€ ì ìš©]
        async function openShelfDetail(id) {
            currentShelfId = id;
            document.getElementById('shelf-container').style.display = 'none';
            document.getElementById('shelf-content-area').style.display = 'block';
            
            const sDoc = await db.collection("shelves").doc(id).get();
            const sData = sDoc.data();
            
            // í´ë” ì´ëª¨ì§€ ëŒ€ì‹  ì„œì¬ í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ
            document.getElementById('shelf-header-info').innerHTML = `
                <div class="shelf-profile-header">
                    <img src="${sData.img}" class="shelf-profile-img" onerror="this.src='https://via.placeholder.com/150'">
                    <h2 style="color:white; margin:0;">${sData.name}</h2>
                </div>`;
            
            const list = document.getElementById('shelf-book-list');
            list.className = "shelf-grid";
            const booksInShelf = allMyBooks.filter(b => b.shelf === id);
            list.innerHTML = booksInShelf.length === 0 ? "<p style='grid-column:span 3; text-align:center; color:#555; padding:40px 0;'>ë¹„ì–´ìˆëŠ” ì„œì¬ì…ë‹ˆë‹¤.</p>" : "";

            booksInShelf.forEach(b => {
                const stars = "â­".repeat(b.rating || 0);
                let bClass = b.status === 'done' ? "badge-done" : (b.status === 'reading' ? "badge-reading" : "badge-wish");
                let bText = b.status === 'done' ? "ì™„ë…" : (b.status === 'reading' ? "ì½ëŠ”ì¤‘" : "ì˜ˆì •");
                list.innerHTML += `
                    <div class="book-card" onclick="openDetailPage('${b.id}')">
                        <div class="book-cover-wrapper">
                            <div class="status-badge ${bClass}">${bText}</div>
                            <img src="${b.thumbnail}" class="book-cover" onerror="this.src='https://via.placeholder.com/150'">
                        </div>
                        <div class="card-info">
                            <div class="card-title">${b.title}</div>
                            <div class="card-author">${b.author}</div>
                            <div class="card-stars">${stars}</div>
                        </div>
                    </div>`;
            });
        }

        function goBackToShelves() {
            currentShelfId = null;
            document.getElementById('library-filter-search').value = ""; 
            document.getElementById('shelf-container').style.display = 'block';
            document.getElementById('shelf-content-area').style.display = 'none';
            loadShelves();
        }

        async function openDetailPage(bookId) {
            const doc = await db.collection("my_books").doc(bookId).get();
            const b = doc.data();
            const page = document.getElementById('book-detail-page');
            const stars = "â­".repeat(b.rating || 0);
            const quotesHtml = (b.quotes || []).map(q => `<div class="quote-item">"${q}"</div>`).join('');
            document.getElementById('detail-body').innerHTML = `
                <div class="detail-hero">
                    <img src="${b.thumbnail}" class="hero-cover" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="hero-info">
                        <h2 style="margin:0; font-size:1.1rem; color:white;">${b.title}</h2>
                        <div style="color:#888; margin-top:4px; font-size:0.85rem;">${b.author}</div>
                        <div style="color:#666; font-size:0.75rem;">${b.publisher || ''}</div>
                        <div style="margin-top:10px; font-size:0.8rem; color:var(--point-color);">${stars}</div>
                    </div>
                </div>
                <div class="detail-content">
                    <span class="detail-label">ìƒíƒœ</span>
                    <div class="info-row" style="color:#fff;">${b.status === 'done' ? 'âœ… ì™„ë…' : (b.status === 'reading' ? 'ğŸ“– ì½ëŠ” ì¤‘' : 'ğŸ“Œ ì½ì„ ì˜ˆì •')}</div>
                    <span class="detail-label">ë¬¸ì¥ ê¸°ë¡</span>
                    ${quotesHtml || '<div style="color:#444; margin-top:10px;">ê¸°ë¡ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>'}
                    <span class="detail-label">ê°ìƒí‰</span>
                    <div class="comment-box">${b.comment || 'ê¸°ë¡ëœ ê°ìƒí‰ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                    <div style="display:flex; gap:10px; margin-top:40px;">
                        <button class="btn btn-sub" onclick="prepareEdit('${bookId}')">ìˆ˜ì •</button>
                        <button class="btn" style="background:#422; color:#f77;" onclick="deleteBook('${bookId}')">ì‚­ì œ</button>
                    </div>
                </div>`;
            page.style.display = 'block'; document.body.style.overflow = 'hidden';
        }

        async function saveRecord() {
            const shelfVal = document.getElementById('shelf-select').value;
            const data = { 
                title: document.getElementById('edit-title').value,
                author: document.getElementById('edit-author').value,
                publisher: document.getElementById('edit-publisher').value,
                thumbnail: document.getElementById('edit-thumbnail').value,
                status: document.getElementById('status-select').value, 
                finishDate: document.getElementById('finish-date').value, 
                rating: document.getElementById('rating-select').value, 
                quotes: Array.from(document.querySelectorAll('.quote-item-input')).map(i => i.value).filter(v => v.trim()), 
                comment: document.getElementById('comment-input').value, 
                shelf: shelfVal, 
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            if(editingBookId) await db.collection("my_books").doc(editingBookId).update(data);
            else await db.collection("my_books").add(data);
            closeModal('record-modal'); closeDetailPage();
            if(currentShelfId) openShelfDetail(currentShelfId); else loadShelves();
        }

        async function openRecordModal(book, isEdit = false, docId = null) {
            editingBookId = docId;
            document.getElementById('edit-title').value = book.title || "";
            document.getElementById('edit-author').value = book.author || "";
            document.getElementById('edit-publisher').value = book.publisher || "";
            document.getElementById('edit-thumbnail').value = book.thumbnail || "";
            document.getElementById('quote-area').innerHTML = "";
            document.getElementById('status-select').value = book.status || 'wish';
            document.getElementById('rating-select').value = book.rating || '5';
            document.getElementById('comment-input').value = book.comment || '';
            if(isEdit) (book.quotes || []).forEach(q => addQuoteInput(q)); else addQuoteInput();
            const sSnap = await db.collection("shelves").get();
            document.getElementById('shelf-select').innerHTML = sSnap.docs.map(d => `<option value="${d.id}" ${book.shelf === d.id ? 'selected' : ''}>${d.data().name}</option>`).join('');
            document.getElementById('record-modal').style.display = 'block';
        }

        document.getElementById('realtime-search').addEventListener('input', function(e) {
            clearTimeout(searchTimer);
            const query = e.target.value;
            if (query.length < 2) return;
            searchTimer = setTimeout(async () => {
                const res = await fetch(`https://dapi.kakao.com/v3/search/book?query=${query}&sort=accuracy&size=20`, { headers: { Authorization: `KakaoAK ${KAKAO_KEY}` } });
                const data = await res.json();
                document.getElementById('book-list').innerHTML = data.documents.map(b => `
                    <div style="display:flex; gap:12px; background:#1e1e1e; padding:10px; border-radius:10px; margin-bottom:10px; cursor:pointer;" onclick="openRecordModal({title:'${b.title.replace(/'/g,"")}', thumbnail:'${b.thumbnail}', author:'${b.authors.join(", ")}', publisher:'${b.publisher}'})">
                        <img src="${b.thumbnail || 'https://via.placeholder.com/150'}" style="width:45px; border-radius:4px;">
                        <div><div style="font-size:0.9rem; font-weight:bold;">${b.title}</div><small style="color:#777;">${b.authors[0]}</small></div>
                    </div>`).join('') + `<div style="margin-top:20px; padding:15px; text-align:center; border:2px dashed #333; border-radius:12px; cursor:pointer; background:#1a1a1a;" onclick="openRecordModal({title:'${query}', thumbnail:'https://via.placeholder.com/150', author:'', publisher:''})"><div style="color:var(--point-color); font-weight:bold;">ğŸ” ì°¾ëŠ” ê²°ê³¼ê°€ ì—†ë‚˜ìš”? ì§ì ‘ ì…ë ¥í•˜ê¸°</div></div>`;
            }, 400);
        });

        async function prepareEdit(bookId) {
            const doc = await db.collection("my_books").doc(bookId).get();
            openRecordModal(doc.data(), true, bookId);
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id + '-section').classList.add('active');
            if(id === 'search' || id === 'library') document.getElementById('tab-' + id).classList.add('active');
            if(id === 'library') goBackToShelves(); 
        }

        function closeDetailPage() { document.getElementById('book-detail-page').style.display = 'none'; document.body.style.overflow = 'auto'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function toggleDateInput() { document.getElementById('date-input-group').style.display = (document.getElementById('status-select').value === 'done') ? 'block' : 'none'; }
        function addQuoteInput(val = "") {
            const div = document.createElement('div'); div.style.display="flex"; div.style.marginTop="5px"; div.style.gap="5px";
            div.innerHTML = `<input type="text" class="quote-item-input" value="${val}" style="flex:1;"><button onclick="this.parentElement.remove()" style="color:#f77; background:none; border:none; width:30px;">âœ•</button>`;
            document.getElementById('quote-area').appendChild(div);
        }
        async function deleteBook(id) { if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await db.collection("my_books").doc(id).delete(); closeDetailPage(); if(currentShelfId) openShelfDetail(currentShelfId); else loadShelves(); } }

        loadShelves();
    </script>
</body>
</html>